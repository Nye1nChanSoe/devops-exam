- hosts: all
  vars:
    app_dir: /home/laborant/app

  tasks:
    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: laborant
        group: laborant
        mode: "0755"

    - name: Copy application files
      copy:
        src: dist/
        dest: "{{ app_dir }}"
        owner: laborant
        group: laborant

    - name: Install production dependencies
      command: npm ci --omit=dev
      args:
        chdir: "{{ app_dir }}"

    - name: Create systemd service
      become: true
      copy:
        src: node-app.service
        dest: /etc/systemd/system/node-app.service

    - name: Start the service
      become: true
      ansible.builtin.systemd:
        name: node-app.service
        daemon_reload: true
        state: restarted
        enabled: true
