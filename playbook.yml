- hosts: all
  become: true

  tasks:
    - name: Verify Docker is available
      ansible.builtin.command: docker --version
      changed_when: false

    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

    - name: Pull application image
      ansible.builtin.command: docker pull ttl.sh/myapp:2h

    - name: Stop old container if running
      ansible.builtin.command: docker stop myapp
      ignore_errors: true

    - name: Remove old container if exists
      ansible.builtin.command: docker rm myapp
      ignore_errors: true

    - name: Run application container
      ansible.builtin.command: >
        docker run -d
        --name myapp
        --restart always
        -p 4444:4444
        ttl.sh/myapp:2h
